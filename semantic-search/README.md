# 의미 기반 검색

**ChromaDB** 기반 벡터 검색을 통해, 의미적으로 유사한 오류 문장을 찾기 위한 작업입니다.
문장은 **Sentence Transformers** 기반 768차원 임베딩으로 변환되며, 코사인 유사도 기반으로 검색을 수행합니다.

<br>

## 1. 데이터 전처리

> 전처리 작업에 대한 코드는 깃허브에 업로드되어 있지 않습니다.

- 쓰기 피드백을 제공해야 하므로, 데이터 셋 중 '문어' 정보인 파일들만 필터링합니다.

- 임베딩을 위해 필요한 데이터 형식을 정의합니다. 해당 프로젝트의 경우 다음과 같은 JSON 형식을 사용합니다.

    ```JSON
        [
            {
                "file_number": "데이터 셋 파일의 인덱스 + 4자리 UUID",
                "grade": "TOPIK 등급",
                "mother_language": "모어",
                "original_sentence": "원본 문장",
                "words": [
                    {"form": "어절", "morphs": [
                        {"morph": "형태소", "pos": "품사"},
                        {"morph": "형태소", "pos": "품사"},
                    ]},
                ],
                "error_words": [
                    {
                        "text": "오류 어절 -> 교정 어절",
                        "error_location": "오류 위치",
                        "error_aspect": "오류 양상",
                        "error_level": "오류 층위"
                    },
                    {
                        "text": "오류 어절 -> 교정 어절",
                        "error_location": "오류 위치",
                        "error_aspect": "오류 양상",
                        "error_level": "오류 층위"
                    },
                ]
            },
        ]
    ```

- 데이터 셋으로부터 필요한 정보만을 추출해, JSON 형태의 데이터로 재가공합니다.

<br>

---

## 2. 벡터화 및 임베딩

> sentence transformers 5.1.2, chromadb 1.1.1

도커 컨테이너를 활용하여 각각 **원문 문장, 오류 교정 정보**를 검색 키로 하는 벡터 데이터베이스 서버를 구축합니다.

<br>

- `embedding/embed-sentence`는 **원문 문장을 임베딩**하고, 오류 관련 정보(오류 교정 정보, 오류 위치, 오류 양상, 오류 층위)는 메타데이터에 포함합니다.

- `embedding/embed-error-words`는 **오류 교정 정보를 임베딩**하고, 오류 위치, 오류 양상, 오류 층위는 메타데이터에 포함합니다.

- **TOPIK 등급, 학습자 모어 정보, 문장의 형태소 분석 정보**는 공통적인 메타데이터로 저장됩니다.

<br>

---

## 3. 검색 성능 테스트

테스트 스크립트를 통해 검색 테스트를 수행합니다. 

<br>

- `testing/search-from-sentence`
- `testing/search-from-error-words`

각각의 스크립트는 요청을 보내는 서버 주소(현재는 localhost에서 테스트를 진행하여 port만 다름) 및 출력 형식에 차이가 있습니다.

<br>

---

<br>

초기 설계 단계에서는 두 가지 임베딩 방식을 모두 실험하였으나,  
오류 교정 정보만을 기준으로 한 방식은 문맥 정보가 제한되어 검색 안정성이 낮다는 한계가 확인되었습니다.  
이에 따라 현재 시스템에서는 **원문 문장을 임베딩하여 검색 키로 사용하는** `search-from-sentence` 방식을 채택하여 사용하고 있습니다.
